#!/bin/bash

if [ "$CI" != "true" ]; then
	echo "build script can only run in CI environment"
	exit 1
fi

REPO_URL="https://${GIT_TOKEN}@github.com/roblox-ts/types.git"

echo "setup git config for CI"
git config --global user.email "travis@travis-ci.org"
git config --global user.name "Travis CI"

echo "compile with typescript"
npx tsc

echo "run build"
node out/index.js

echo "detect master changes (generated files)"
git add .
if git diff-index --quiet HEAD --; then
	echo "push master (generated files)"
	git commit -m "Update generated files [skip ci]" > /dev/null
	git push $REPO_URL > /dev/null

	echo "run typedoc"
	npm run typedoc > /dev/null

	echo "detect master changes (typedoc)"
	git add .
	if git diff-index --quiet HEAD --; then
		echo "push master (typedoc)"
		git commit -m "Update typedoc files [skip ci]" > /dev/null
		git push $REPO_URL > /dev/null
	fi
fi

echo "clone deploy branch"
cd ..
git clone --depth=50 --branch=deploy $REPO_URL deploy

echo "copy possible changed files"
ls
mkdir -p deploy/include
rm -rf deploy/include/*
cp -r types/include/* deploy/include
cp types/plugin.d.ts deploy/plugin.d.ts
cp types/README.md deploy/README.md
cd deploy

echo "detect deploy changes"
git add .
if git diff-index --quiet HEAD --; then
	if [ "$TRAVIS_EVENT_TYPE" == "cron" ]; then
		git commit -m "Automatic Update" > /dev/null
	else
		git commit -m "Manual Update" > /dev/null
	fi
	echo "push deploy"
	git push $REPO_URL deploy > /dev/null
fi
