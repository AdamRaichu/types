#!/bin/bash

if [[ -z "${CI}"] ]; then
	echo "setup git config for CI"
	git config --global user.email "travis@travis-ci.org"
	git config --global user.name "Travis CI"
fi

echo "compile with typescript"
npx tsc

echo "run build"
node out/index.js

echo "detect master changes (generated files)"
git add .
git status
if git diff-index --quiet HEAD --; then
	echo "push master (generated files)"
	git commit -m "Update generated files [skip ci]"
	git push https://${GIT_TOKEN}@github.com/roblox-ts/types.git HEAD:master

	echo "run typedoc"
	npm run typedoc

	echo "detect master changes (typedoc)"
	git add .
	git status
	if git diff-index --quiet HEAD --; then
		echo "push master (typedoc)"
		git commit -m "Update typedoc files [skip ci]"
		git push https://${GIT_TOKEN}@github.com/roblox-ts/types.git HEAD:master
	fi
fi

echo "clone deploy branch"
cd ..
git clone --depth=50 --branch=deploy https://github.com/roblox-ts/types.git deploy

echo "copy possible changed files"
ls
mkdir -p deploy/include
rm -rf deploy/include/*
cp -r types/include/* deploy/include
cp types/plugin.d.ts deploy/plugin.d.ts
cp types/README.md deploy/README.md
cd deploy

echo "detect deploy changes"
git add .
git status
if git diff-index --quiet HEAD --; then
	if [ "$TRAVIS_EVENT_TYPE" == "cron" ]; then
		git commit -m "Automatic Update"
	else
		git commit -m "Manual Update"
	fi
	echo "push deploy"
	git push https://${GIT_TOKEN}@github.com/roblox-ts/types.git deploy
fi
